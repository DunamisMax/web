{% extends "base.html" %}

{% block title %}{{ agent.name }} - DunamisMax AI Agents{% endblock %}

{% block content %}
<div class="chat-page fade-in">
    <header class="converter-header">
        <a href="/" class="back-link">
            <i data-feather="arrow-left"></i>
            Back to Agents
        </a>
        <h1>{{ agent.name }}</h1>
        <p class="tagline">{{ agent.description }}</p>
    </header>

    <div class="converter-container card">
        <div class="converter-header">
            <h2>
                <i data-feather="{{ agent.icon }}"></i>
                Chat Session
            </h2>
            <p class="format-info">Real-time conversation with {{ agent.name }}</p>
        </div>

        <div class="chat-container">
            <div class="chat-messages" id="chat-messages">
                <div class="message system">
                    <div class="message-content">
                        <i data-feather="info"></i>
                        <span>Connected to {{ agent.name }}. Start chatting!</span>
                    </div>
                </div>
            </div>

            <div class="message-input">
                <form id="message-form" onsubmit="return sendMessage(event)">
                    <div class="input-group">
                        <input 
                            type="text" 
                            id="message-input"
                            placeholder="Type your message..." 
                            autocomplete="off"
                            required
                        >
                        <button type="submit" class="btn">
                            <i data-feather="send"></i>
                            Send
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="connection-status" class="connection-status" style="display: none;">
        <i data-feather="wifi-off"></i>
        <span>Reconnecting...</span>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let ws = null;
const messagesContainer = document.getElementById('chat-messages');
const messageInput = document.getElementById('message-input');
const connectionStatus = document.getElementById('connection-status');

function connectWebSocket() {
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${protocol}//${window.location.host}/ws/chat/{{ agent.id }}`;
    
    ws = new WebSocket(wsUrl);

    ws.onopen = () => {
        connectionStatus.style.display = 'none';
    };

    ws.onclose = () => {
        connectionStatus.style.display = 'flex';
        setTimeout(connectWebSocket, 1000);
    };

    ws.onmessage = (event) => {
        const message = JSON.parse(event.data);
        addMessage(message);
    };
}

function sendMessage(event) {
    event.preventDefault();
    const message = messageInput.value.trim();
    
    if (message && ws && ws.readyState === WebSocket.OPEN) {
        addMessage({
            type: 'message',
            role: 'user',
            content: message
        });

        ws.send(message);
        messageInput.value = '';
        messageInput.focus();
    }
    return false;
}

function addMessage(message) {
    if (message.is_error) {
        createMessageElement(message);
        return;
    }

    if (message.is_chunk) {
        if (message.is_complete) {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            return;
        }

        if (message.is_first_chunk) {
            createMessageElement(message);
        } else {
            const lastMessage = messagesContainer.lastElementChild;
            if (lastMessage && lastMessage.classList.contains('assistant')) {
                const contentDiv = lastMessage.querySelector('.message-content');
                contentDiv.textContent += message.content;
            }
        }
    } else {
        createMessageElement(message);
    }
    
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function createMessageElement(message) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${message.role}`;
    
    const contentDiv = document.createElement('div');
    contentDiv.className = 'message-content';
    
    if (message.is_error) {
        contentDiv.innerHTML = `<i data-feather="alert-triangle"></i><span>${message.content}</span>`;
    } else {
        contentDiv.textContent = message.content || '';
    }
    
    messageDiv.appendChild(contentDiv);
    messagesContainer.appendChild(messageDiv);
    feather.replace();
}

document.addEventListener('DOMContentLoaded', function() {
    feather.replace();
    connectWebSocket();
    messageInput.focus();
});
</script>
{% endblock %}