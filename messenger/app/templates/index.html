{% extends "base.html" %}

{% block content %}
<div class="messenger-page fade-in">
    <!-- Messenger Page Title -->
    <h2 class="page-title">DunamisMax Messenger</h2>
    
    <!-- Username Form -->
    <div id="username-form" class="card login-card">
        <h3 class="centered-text">Welcome to DunamisMax Messenger</h3>
        <p class="form-description centered-text">Choose a username to start messaging</p>
        <form onsubmit="return connectToChat(event)" class="form-group">
            <div class="input-wrapper">
                <input 
                    type="text" 
                    id="username-input"
                    placeholder="Enter username..." 
                    pattern="[A-Za-z0-9_]{3,15}"
                    title="3-15 characters, letters, numbers, and underscores only"
                    required
                    autocomplete="off"
                >
                <span class="input-help">3-15 characters, letters, numbers, and underscores only</span>
            </div>
            <button type="submit" class="btn">
                <i data-feather="log-in"></i>
                Join Chat
            </button>
        </form>
    </div>

    <!-- Chat Interface (Hidden by default) -->
    <div id="chat-interface" class="messenger-container card" style="display: none;">
        <div class="chat-header">
            <div class="chat-status">
                <span id="connection-indicator" class="indicator offline"></span>
                <span id="status-text">Not Connected</span>
            </div>
            <button onclick="disconnectFromChat()" class="btn btn-small btn-outline" title="Leave Chat">
                <i data-feather="log-out"></i>
                Leave
            </button>
        </div>

        <div class="message-list" id="message-list">
            <div class="message system">
                <div class="message-content">
                    <i data-feather="info" class="message-icon"></i>
                    Welcome to DunamisMax Messenger!
                </div>
            </div>
        </div>

        <div class="message-input">
            <form id="message-form" onsubmit="return sendMessage(event)">
                <div class="input-group">
                    <input 
                        type="text" 
                        id="message-input"
                        placeholder="Type your message..." 
                        autocomplete="off"
                        required
                    >
                    <button type="submit" class="btn">
                        <i data-feather="send"></i>
                        Send
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // JavaScript Code for Messenger Functionality

    // WebSocket variable
    let ws = null;
    let username = '';

    // DOM Elements
    const messageList = document.getElementById('message-list');
    const messageForm = document.getElementById('message-form');
    const messageInput = document.getElementById('message-input');
    const usernameForm = document.getElementById('username-form');
    const chatInterface = document.getElementById('chat-interface');
    const connectionIndicator = document.getElementById('connection-indicator');
    const statusText = document.getElementById('status-text');

    /**
     * Connect to the chat WebSocket server
     * @param {Event} event - The form submission event
     * @returns {boolean} - Prevents default form submission
     */
    function connectToChat(event) {
        event.preventDefault();
        username = document.getElementById('username-input').value.trim();
        
        if (!username) return false;

        // Determine WebSocket protocol based on page protocol
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/ws/chat/${encodeURIComponent(username)}`;
        
        ws = new WebSocket(wsUrl);

        // Handle successful connection
        ws.onopen = function() {
            connectionIndicator.className = 'indicator online';
            statusText.textContent = 'Connected';
            usernameForm.style.display = 'none';
            chatInterface.style.display = 'flex';
            messageInput.focus();
        };

        // Handle connection closure
        ws.onclose = function(event) {
            connectionIndicator.className = 'indicator offline';
            statusText.textContent = 'Disconnected';
            
            if (event.code === 1008) {
                showError('Username already taken. Please choose another.');
                usernameForm.style.display = 'block';
                chatInterface.style.display = 'none';
            } else {
                addSystemMessage('Disconnected from server. Please refresh to reconnect.');
            }
        };

        // Handle connection errors
        ws.onerror = function(error) {
            console.error('WebSocket error:', error);
            addSystemMessage('Connection error occurred');
        };

        // Handle incoming messages
        ws.onmessage = function(event) {
            const message = JSON.parse(event.data);
            addMessage(message);
        };

        return false;
    }

    /**
     * Disconnect from the chat WebSocket server
     */
    function disconnectFromChat() {
        if (ws) {
            ws.close();
        }
        usernameForm.style.display = 'block';
        chatInterface.style.display = 'none';
        messageList.innerHTML = '';
        addSystemMessage('Welcome to DunamisMax Messenger!');
    }

    /**
     * Add a message to the message list
     * @param {Object} message - The message object
     */
    function addMessage(message) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${message.type}`;

        if (message.type === 'system') {
            messageDiv.innerHTML = `
                <div class="message-content">
                    <i data-feather="info" class="message-icon"></i>
                    ${escapeHtml(message.text)}
                </div>
            `;
        } else {
            const time = new Date(message.timestamp).toLocaleTimeString();
            messageDiv.innerHTML = `
                <div class="message-header">
                    <span class="username">${escapeHtml(message.username)}</span>
                    <span class="timestamp">${time}</span>
                </div>
                <div class="message-content">
                    ${escapeHtml(message.text)}
                </div>
            `;
        }

        messageList.appendChild(messageDiv);
        messageList.scrollTop = messageList.scrollHeight;
        
        // Re-initialize Feather icons for new content
        feather.replace();
    }

    /**
     * Add a system message to the message list
     * @param {string} text - The system message text
     */
    function addSystemMessage(text) {
        const message = {
            type: 'system',
            text: text,
            timestamp: new Date().toISOString()
        };
        addMessage(message);
    }

    /**
     * Display an error message
     * @param {string} text - The error message text
     */
    function showError(text) {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'error-message fade-in';
        errorDiv.innerHTML = `
            <i data-feather="alert-circle"></i>
            <span>${escapeHtml(text)}</span>
        `;
        usernameForm.insertBefore(errorDiv, usernameForm.firstChild);
        feather.replace();
        
        // Remove error after 5 seconds
        setTimeout(() => {
            errorDiv.remove();
        }, 5000);
    }

    /**
     * Send a message through the WebSocket
     * @param {Event} event - The form submission event
     * @returns {boolean} - Prevents default form submission
     */
    function sendMessage(event) {
        event.preventDefault();
        if (ws && ws.readyState === WebSocket.OPEN) {
            const message = messageInput.value.trim();
            if (message) {
                ws.send(message);
                messageInput.value = '';
                messageInput.focus();
            }
        } else {
            addSystemMessage('Not connected to server');
        }
        return false;
    }

    /**
     * Escape HTML to prevent XSS
     * @param {string} unsafe - The unsafe string
     * @returns {string} - The escaped string
     */
    function escapeHtml(unsafe) {
        return unsafe
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    // Handle Enter key in username input
    document.getElementById('username-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            connectToChat(e);
        }
    });

    // Focus username input on load
    window.addEventListener('load', function() {
        document.getElementById('username-input').focus();
    });
</script>
{% endblock %}
