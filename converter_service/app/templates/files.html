{% extends "base.html" %}

{% block content %}
<div class="converter-page fade-in">
  <header class="messenger-header">
    <div class="logo">
      <i data-feather="file-text"></i>
      <h1>DunamisMax File Converter</h1>
    </div>
    <p class="tagline">Professional Media Transformation Studio</p>
  </header>

  <div class="messenger-container card">
    <div class="chat-header">
      <div class="converter-status">
        <span id="status-text">Ready for conversion</span>
      </div>
      <!-- Format pills can be expanded to show some popular ones -->
      <div class="format-pills">
        <span class="format-pill">MP3</span>
        <span class="format-pill">WAV</span>
        <span class="format-pill">FLAC</span>
        <span class="format-pill">MP4</span>
        <span class="format-pill">MOV</span>
        <span class="format-pill">JPG</span>
        <span class="format-pill">PNG</span>
        <span class="format-pill">GIF</span>
        <!-- Add more if desired, e.g., WEBP, WMA, etc. -->
      </div>
    </div>

    <div class="converter-interface">
      <div class="drop-zone card" id="dropZone">
        <div class="drop-content">
          <i data-feather="upload-cloud"></i>
          <h3>Drag & Drop Files</h3>
          <p>or click to browse your device</p>
          <div class="format-info">
            Supported formats: Audio, Video, Images
          </div>
        </div>
        <!-- Add a comprehensive accept list (or let the user pick anything).
             This is purely a hint for the browser's file chooser. -->
        <input
          type="file"
          id="fileInput"
          hidden
          accept=".mp3,.wav,.ogg,.flac,.aac,.m4a,.wma,
                  .mp4,.mov,.avi,.mkv,.webm,.mpeg,.3gp,.ts,
                  .jpg,.jpeg,.png,.gif,.bmp,.webp,.tif,.tiff"
        />
      </div>

      <div class="conversion-controls">
        <div class="input-group">
          <div class="select-wrapper">
            <select id="formatSelect" class="custom-select">
              <optgroup label="Audio Formats">
                <option value="mp3">MP3</option>
                <option value="wav">WAV</option>
                <option value="flac">FLAC</option>
                <option value="aac">AAC</option>
                <option value="ogg">OGG</option>
                <option value="m4a">M4A</option>
                <option value="wma">WMA</option>
              </optgroup>
              <optgroup label="Video Formats">
                <option value="mp4">MP4</option>
                <option value="mov">MOV</option>
                <option value="avi">AVI</option>
                <option value="mkv">MKV</option>
                <option value="webm">WebM</option>
                <option value="mpeg">MPEG</option>
                <option value="3gp">3GP</option>
                <option value="ts">TS</option>
              </optgroup>
              <optgroup label="Image Formats">
                <option value="jpg">JPG</option>
                <option value="jpeg">JPEG</option>
                <option value="png">PNG</option>
                <option value="gif">GIF</option>
                <option value="bmp">BMP</option>
                <option value="webp">WEBP</option>
                <option value="tif">TIF</option>
                <option value="tiff">TIFF</option>
              </optgroup>
            </select>
            <i data-feather="chevron-down"></i>
          </div>
          <button id="convertButton" class="btn">
            <i data-feather="zap"></i>
            Convert
          </button>
        </div>
      </div>

      <div class="conversion-list" id="conversionList">
        <!-- Conversion items will be added dynamically here -->
      </div>
    </div>
  </div>

  <!-- Optional Features / Selling Points -->
  <div class="features-grid">
    <div class="card feature-card">
      <i data-feather="zap"></i>
      <h4>Real-time Chat</h4>
      <p>Instant responses with streaming messages</p>
    </div>
    <div class="card feature-card">
      <i data-feather="shield"></i>
      <h4>Secure</h4>
      <p>Private conversations, no data stored</p>
    </div>
    <div class="card feature-card">
      <i data-feather="cpu"></i>
      <h4>Expert Knowledge</h4>
      <p>Specialized agents for different topics</p>
    </div>
    <div class="card feature-card">
      <i data-feather="users"></i>
      <h4>Free to Use</h4>
      <p>No registration required</p>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let activeConversions = new Map();

    document.addEventListener('DOMContentLoaded', function() {
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const convertButton = document.getElementById('convertButton');
        const statusText = document.getElementById('status-text');
        const conversionList = document.getElementById('conversionList');

        // Drag and drop handling
        function handleDragEvent(e) {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.toggle('dragover', e.type === 'dragover');
        }

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, handleDragEvent);
        });

        dropZone.addEventListener('drop', async (e) => {
            const file = e.dataTransfer.files[0];
            if (file) await handleFileSelection(file);
        });

        fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) await handleFileSelection(file);
        });

        dropZone.addEventListener('click', () => fileInput.click());

        async function handleFileSelection(file) {
            const conversionId = crypto.randomUUID();

            // Add conversion item to list
            const conversionItem = document.createElement('div');
            conversionItem.className = 'conversion-item';
            conversionItem.innerHTML = `
                <div class="conversion-info">
                    <i data-feather="file"></i>
                    <span class="filename">${file.name}</span>
                </div>
                <div class="conversion-progress">
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: 0%"></div>
                    </div>
                    <span class="progress-text">Preparing...</span>
                </div>
            `;
            conversionList.insertBefore(conversionItem, conversionList.firstChild);
            feather.replace();

            // Start conversion
            try {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('output_format', document.getElementById('formatSelect').value);

                const response = await fetch('/api/convert', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) throw new Error('Conversion failed to start');

                const data = await response.json();
                activeConversions.set(conversionId, {
                    element: conversionItem,
                    taskId: data.task_id
                });

                // Start polling for status
                pollConversionStatus(data.task_id, conversionItem);

            } catch (error) {
                conversionItem.querySelector('.progress-text').textContent = 'Error: ' + error.message;
                conversionItem.classList.add('error');
            }
        }

        async function pollConversionStatus(taskId, conversionItem) {
            const progressFill = conversionItem.querySelector('.progress-fill');
            const progressText = conversionItem.querySelector('.progress-text');

            while (true) {
                try {
                    const response = await fetch(`/api/conversion-status/${taskId}`);
                    const data = await response.json();

                    switch (data.status) {
                        case 'completed':
                            progressFill.style.width = '100%';
                            progressText.textContent = 'Completed';
                            conversionItem.classList.add('completed');

                            // Add download button
                            const downloadBtn = document.createElement('a');
                            downloadBtn.href = data.download_url;
                            downloadBtn.className = 'btn btn-small';
                            downloadBtn.innerHTML = '<i data-feather="download"></i> Download';
                            conversionItem.appendChild(downloadBtn);
                            feather.replace();
                            return;

                        case 'failed':
                            progressText.textContent = `Error: ${data.error}`;
                            conversionItem.classList.add('error');
                            return;

                        case 'processing':
                            progressFill.style.width = '50%';
                            progressText.textContent = 'Converting...';
                            break;
                    }

                    await new Promise(resolve => setTimeout(resolve, 1000));
                } catch (error) {
                    progressText.textContent = 'Status check failed';
                    conversionItem.classList.add('error');
                    return;
                }
            }
        }
    });
    </script>
    {% endblock %}