{% extends "base.html" %}

{% block content %}
<div class="page-wrapper">
    <div class="container">
        <h1>File Converter</h1>
        <p class="tagline nord4">Transform media files between formats with studio quality</p>

        <div class="converter-container card nord1-bg">
            <div class="converter-header">
                <h2 class="nord8"><i data-feather="refresh-cw"></i> File Converter</h2>
                <p class="nord4">Supported formats: MP3, WAV, OGG, FLAC, MP4, MOV, AVI</p>
            </div>

            <div class="drop-zone nord3-border" id="dropZone">
                <i data-feather="upload" class="nord4"></i>
                <p class="nord4">Drag & drop files or click to browse</p>
                <input type="file" id="fileInput" hidden accept=".mp3,.wav,.ogg,.flac,.mp4,.mov,.avi">
            </div>

            <div class="conversion-options nord3-bg">
                <div class="form-group">
                    <label class="nord4">Output Format:</label>
                    <select id="formatSelect" class="custom-select nord3-bg nord4">
                        <optgroup label="Audio Formats">
                            <option value="mp3">MP3</option>
                            <option value="wav">Standard WAV</option>
                            <option value="voicemail_wav">Voicemail WAV</option>
                        </optgroup>
                        <optgroup label="Video Formats">
                            <option value="mp4">MP4</option>
                            <option value="mov">MOV</option>
                        </optgroup>
                    </select>
                </div>
            </div>

            <div class="processing-ui">
                <div class="progress-bar nord3-bg">
                    <div class="progress-fill nord8-bg" id="progressFill"></div>
                </div>
                <div class="status-text nord4" id="statusText">Ready for conversion</div>
                <div class="conversion-results" id="resultsContainer"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", function () {
    const dropZone = document.getElementById("dropZone");
    const fileInput = document.getElementById("fileInput");
    
    if (!dropZone || !fileInput) {
        console.error("Drop zone or file input not found!");
        return;
    }

    // ✅ Click event to open file explorer
    dropZone.addEventListener("click", function () {
        fileInput.click();
    });

    // ✅ Handle file selection from file explorer
    fileInput.addEventListener("change", function (event) {
        if (event.target.files.length > 0) {
            handleFileUpload(event.target.files[0]);
        }
    });

    // ✅ Drag & Drop Handling
    dropZone.addEventListener("dragover", function (event) {
        event.preventDefault();
        dropZone.classList.add("dragover");
    });

    dropZone.addEventListener("dragleave", function () {
        dropZone.classList.remove("dragover");
    });

    dropZone.addEventListener("drop", function (event) {
        event.preventDefault();
        dropZone.classList.remove("dragover");

        if (event.dataTransfer.files.length > 0) {
            fileInput.files = event.dataTransfer.files;  // Set files for upload
            handleFileUpload(event.dataTransfer.files[0]);
        }
    });

    // ✅ Function to handle file uploads
    function handleFileUpload(file) {
        console.log("Selected file:", file.name);

        // Show progress UI
        document.getElementById("statusText").textContent = "Uploading " + file.name + "...";
        document.getElementById("progressFill").style.width = "50%";

        const formData = new FormData();
        formData.append("file", file);
        formData.append("output_format", document.getElementById("formatSelect").value);

        fetch("/api/convert", {
            method: "POST",
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.task_id) {
                pollConversionStatus(data.task_id);
            } else {
                throw new Error("Conversion request failed.");
            }
        })
        .catch(error => {
            document.getElementById("statusText").textContent = "Error: " + error.message;
            document.getElementById("progressFill").style.width = "0%";
        });
    }

    // ✅ Poll conversion status
    function pollConversionStatus(taskId) {
        let attempts = 0;
        const maxAttempts = 60; // 5 minutes (5s intervals)

        const checkStatus = async () => {
            const response = await fetch(`/api/conversion-status/${taskId}`);
            if (!response.ok) throw new Error("Status check failed");
            return await response.json();
        };

        const interval = setInterval(async () => {
            attempts++;
            if (attempts >= maxAttempts) {
                clearInterval(interval);
                document.getElementById("statusText").textContent = "Conversion timeout.";
                return;
            }

            try {
                const status = await checkStatus();

                if (status.status === "completed") {
                    clearInterval(interval);
                    document.getElementById("statusText").textContent = "Conversion complete!";
                    document.getElementById("progressFill").style.width = "100%";

                    const downloadLink = document.createElement("a");
                    downloadLink.className = "btn download-btn";
                    downloadLink.href = status.download_url;
                    downloadLink.innerHTML = `<i data-feather="download"></i> Download Converted File`;
                    
                    const resultsContainer = document.getElementById("resultsContainer");
                    resultsContainer.innerHTML = "";
                    resultsContainer.appendChild(downloadLink);
                    feather.replace();
                } else if (status.status === "failed") {
                    clearInterval(interval);
                    document.getElementById("statusText").textContent = "Conversion failed.";
                } else {
                    document.getElementById("statusText").textContent = `Processing... (${attempts * 5}s elapsed)`;
                    document.getElementById("progressFill").style.width = `${(attempts / maxAttempts) * 100}%`;
                }
            } catch (error) {
                clearInterval(interval);
                document.getElementById("statusText").textContent = "Error checking conversion status.";
            }
        }, 5000);
    }
});
</script>
{% endblock %}
